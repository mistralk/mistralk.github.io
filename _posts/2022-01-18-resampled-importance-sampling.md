---
toc: false
layout: post
description: 
categories: dev/research
title: Resampled Importance Sampling
---

Sampling Importance Resampling(SIR) 또는 Resampled Importance Sampling(RIS){% sidenote 'naming' '전통적인 통계학 맥락에서는 SIR이라는 이름이 주로 쓰이는데, 최근 렌더링 필드의 논문들에서는 어째서인지 RIS라는 이름으로 쓰이는 경향이 있는 듯 하다.' %}은 어떤 확률분포로 샘플링하고 싶은데 샘플링이 어려운 경우에 사용할 수 있는 알고리즘이다. 이름 그대로, 좀더 샘플링하기 쉬운 분포를 이용하여 한번 샘플을 뽑고(sampling), 각 샘플의 중요도(importance)에 따라 다시 샘플링(resampling)한다. 그러면 원래 샘플링하고 싶었던 타겟 분포에 근사하는 분포가 나온다.

렌더링 필드에서 RIS는 옛날부터 알려져 있었지만, 최근들어 다시 주목받고 있다. 2020년 엔비디아가 발표한 ReSTIR 논문[2]에서 이 RIS를 리얼타임 레이 트레이싱의 라이트 샘플링 문제에 활용하여 어마어마한 성능 향상을 보여준 덕분이다.

이 글에서는 가장 기본적인 RIS의 개념에 대해서 소개할 것이다.

## 임포턴스 리샘플링

- 문제: 어떤 **타겟 분포(target distribution)** $$\hat{p}(x)$$로부터 샘플을 뽑고 싶다. 하지만 이 분포로 샘플링하는 것은 어렵다. 다른 말로, 샘플링 코스트가 비싸다.
- 조건: 비교적 샘플링이 쉬운 어떤 **소스 분포(source distribution)** $$p(x)$$를 알고있다. $$\hat{p}(x)$$와 $$p(x)$$가 비슷한 형태라는 사실도 알고 있다.

먼저 $$p$$ 확률분포로 후보 샘플을 $$M$$개 뽑는다($$M \ge 1$$): 

$$
\mathbf{x} = \{x_1, ..., x_M\}
$$

목표는 이 $$p$$ 분포의 샘플들을 적절히 다시 샘플링해서 $$\hat{p}$$ 분포를 띄는 샘플 집합을 만드는 것이다. 샘플들에 다음처럼 가중치를 준다고 생각해보자:

$$
\text{w}(x) = \frac{\hat{p}(x)}{p(x)}
$$

그러면 다음 세 가지 케이스를 확인할 수 있다.

- $$\hat{p}(x) = p(x)$$ 인 경우
  - 해당 샘플을 뽑을 확률이 두 확률분포에서 동일하다.
  - 따라서 가중치를 1로 두면 된다. ($$\text{w}(x) = 1$$)
- $$\hat{p}(x) > p(x)$$ 인 경우
  - 해당 샘플은 소스 분포에서 더 낮은 확률로 뽑힌다.
  - 타겟 분포에서 이 샘플은 더 높은 확률로 뽑혀야만 한다. 
  - 따라서, 그만큼 해당 샘플에 더 가중치를 준다. ($$\text{w}(x) \gt 1$$)
- $$\hat{p}(x) < p(x)$$ 인 경우
  - 해당 샘플은 소스 분포에서 더 높은 확률로 뽑힌다.
  - 타겟 분포에서 이 샘플은 더 낮은 확률로 뽑혀야만 한다.
  - 따라서, 그만큼 해당 샘플에 낮은 가중치를 준다.  ($$\text{w}(x) \lt 1$$)

1. $$\hat{p}(x) = p(x)$$ 인 경우: 해당 샘플을 뽑을 확률이 두 확률분포에서 동일하다. 따라서 가중치를 1로 두면 된다. ($$\text{w}(x) = 1$$)
2. $$\hat{p}(x) > p(x)$$ 인 경우: 해당 샘플은 소스 분포에서 더 낮은 확률로 뽑힌다. 타겟 분포에서 이 샘플은 더 높은 확률로 뽑혀야만 한다. 따라서, 그만큼 해당 샘플에 더 가중치를 준다. ($$\text{w}(x) \gt 1$$)
3. $$\hat{p}(x) < p(x)$$ 인 경우: 해당 샘플은 소스 분포에서 더 높은 확률로 뽑힌다. 타겟 분포에서 이 샘플은 더 낮은 확률로 뽑혀야만 한다. 따라서, 그만큼 해당 샘플에 낮은 가중치를 준다.  ($$\text{w}(x) \lt 1$$)

이 웨이팅 함수를 이용하여, 샘플 후보풀 $$\mathbf{x}$$로부터 랜덤하게 인덱스 $$z \in \{ 1, ..., M \}$$ 를 선택하는 이산확률을 다음처럼 정의할 수 있다.

$$
p(z|\mathbf{x}) = \frac{\text{w}(x_z)}{\sum^M_{i=1} \text{w}(x_i)} \text{ with } \text{w}(x) = \frac{\hat{p}(x)}{p(x)}
$$

이 확률을 이용하여 **리샘플링된 샘플들은 타겟 분포 $$\hat{p}(x)$$에 근사하는 분포를 띈다.**

이러한 리샘플링 과정은 프로포절(proposal) 샘플들을 ‘필터링’하는 프로세스라고 생각할 수 있다. 또한, 프로포절 샘플의 수 $$M$$은 분포의 모양을 ‘보간’하는 변수라고 볼 수 있다. $$M$$이 무한대로 가면 갈수록 각 샘플의 분포는 타겟 분포에 수렴한다.

## 렌더링에서의 활용 예: 매니 라이트 샘플링

레이 트레이싱에서는 일반적으로 각 셰이딩 포인트에서 광원 위의 샘플을 향해 섀도우 레이를 캐스팅한다. 문제는, 섀도우 레이가 씬 내의 지오메트리와 교차하는지(즉 해당 광원이 어떤 물체에 의해 가려지는지)에 대한 판정이 필요하다는 것이다. 이를 가시성 테스트(visibility test)라고 한다. 이 가시성 테스트에는 교차판정 연산이 수반되므로 컴퓨팅 코스트가 상당히 비싸다. 씬 내에 광원이 많으면 많을수록 가시성 테스트의 부담이 커진다.

렌더링 방정식은 다음과 같은 구조를 갖고 있는데, 여기서 가시성 $$V$$를 테스트하기 위해 실제로 섀도우 레이를 발사하고 교차판정을 수행하는 과정이 너무 비싸다는 것이다.

V를 제외한 함수로 샘플링한다. 즉 가시성을 생각하지 않고 광원을 향해 섀도우 레이를 캐스팅한다.

이 문제 구조는 임포턴스 리샘플링이 풀고자 하는 상황과 정확히 일치한다. 


## 레퍼런스

[1]

[2] Bitterli, Benedikt, Chris Wyman, Matt Pharr, Peter Shirley, Aaron Lefohn, and Wojciech Jarosz. "Spatiotemporal reservoir resampling for real-time ray tracing with dynamic direct lighting." *ACM Transactions on Graphics (TOG) 39*, no. 4 (2020): 148-1. 